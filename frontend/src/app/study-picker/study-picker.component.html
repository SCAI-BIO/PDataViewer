<div class="main-container">
  <div class="description-box">
    <h1>Study Picker</h1>
    <p>
      <br />
      The Study Picker is a tool designed to help you efficiently locate cohort datasets that best
      match your research needs. By entering the specific variables or variables of interest, the
      Study Picker will analyze all available datasets and provide a ranked list of cohort studies
      that we have access to, prioritized by how well they align with your criteria.
      <br />
      <br />

      For each accessible cohort, you will find a Plot button that allows you to visualize the
      availability of your selected variables across different visits. This plot presents a clear
      view of data completeness for each variable, enabling you to make informed decisions about the
      suitability of the datasets for your research. Simply enter your variables below, submit your
      query, and explore the cohorts most relevant to your study.
    </p>
  </div>

  <!-- Loading Spinner -->
  @if (isLoading()) {
  <div class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>
  }

  <!-- Study Picker query input -->
  <div class="input-container">
    <mat-form-field>
      <mat-chip-listbox #chipListBox multiple>
        <!-- Loop through selected variables and display them as chips -->
        @for (variable of selectedVariables; track variable) {
        <mat-chip-option
          [selectable]="false"
          [removable]="true"
          (removed)="removeVariable(variable)"
        >
          {{ variable }}
          <mat-icon matChipRemove>cancel</mat-icon>
        </mat-chip-option>
        }
        <input
          matInput
          placeholder="Enter variables of interest"
          [matAutocomplete]="auto"
          [formControl]="variableCtrl"
          (matChipInputTokenEnd)="addVariable($any($event))"
        />
      </mat-chip-listbox>
      <!-- Autocomplete dropdown for variable suggestions -->
      <mat-autocomplete
        #auto="matAutocomplete"
        [displayWith]="displayFn"
        (optionSelected)="optionSelected($event)"
      >
        @for (option of filteredVariables | async; track option) {
        <mat-option [value]="option">
          {{ option }}
        </mat-option>
        }
      </mat-autocomplete>
    </mat-form-field>

    <!-- Button container for ranking cohorts -->
    <div class="button-container">
      <button class="button-style" (click)="fetchRankings(selectedVariables)">Rank cohorts</button>
    </div>
  </div>

  <!-- Table Container -->
  @if (cohortRankings.length > 0) {
  <div class="mat-elevation-z8 table-container">
    <table mat-table [dataSource]="cohortRankings" class="mat-table">
      <ng-container matColumnDef="cohort">
        <th mat-header-cell *matHeaderCellDef>Cohorts (Ranked)</th>
        <td mat-cell *matCellDef="let cohort">
          <span class="color-circle" [style.background-color]="cohortColors[cohort.cohort]"></span>
          {{ cohort.cohort }}
        </td>
      </ng-container>
      <ng-container matColumnDef="found">
        <th mat-header-cell *matHeaderCellDef>Successfully Found</th>
        <td mat-cell *matCellDef="let cohort">{{ cohort.found }}</td>
      </ng-container>
      <ng-container matColumnDef="missing">
        <th mat-header-cell *matHeaderCellDef>Missing Variabless</th>
        <td mat-cell *matCellDef="let cohort" class="missing-variables-cell">
          {{ cohort.missing }}
        </td>
      </ng-container>
      <ng-container matColumnDef="plot">
        <th mat-header-cell *matHeaderCellDef>Longitudinal</th>
        <td mat-cell *matCellDef="let cohort" class="plot-longitudinal-cell">
          @if (isDataAvailable(cohort.cohort)) {
          <a
            class="button-style"
            [routerLink]="'/plot-longitudinal'"
            [queryParams]="{
              cohort: cohort.cohort,
              variables: availableVariables(cohort.missing)
            }"
            target="_blank"
          >
            Plot
          </a>
          } @else {
          <span>Data not available</span>
          }
        </td>
      </ng-container>
      <ng-container matColumnDef="dataAccess">
        <th mat-header-cell *matHeaderCellDef>Data Access</th>
        <td mat-cell *matCellDef="let cohort" class="data-access-cell">
          @if ( cohortLinks[cohort.cohort] === 'Shared by consortium') {
          {{ cohortLinks[cohort.cohort] }}
          } @else { @if (cohortLinks[cohort.cohort]) {
          <a
            class="button-style"
            [href]="cohortLinks[cohort.cohort]"
            target="_blank"
            rel="noopener noreferrer"
          >
            Apply
          </a>
          } }
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
  }
</div>
